image: node:18

services:
  - name: postgres:15-alpine
    alias: postgres

variables:
  POSTGRES_DB: mydatabase
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: mypassword
  DATABASE_URL: "postgresql://myuser:mypassword@postgres:5432/mydatabase?schema=public"
  NODE_ENV: test

stages:
  - prepare
  - test
  - migrate
  - build
  - deploy

cache:
  paths:
    - node_modules/

before_script:
  - apt-get update && apt-get install -y postgresql-client
  - npm ci
  - until pg_isready -h postgres -p 5432 -U myuser; do echo "Waiting for postgres..."; sleep 2; done


generate:
  stage: prepare
  script:
    - apt-get update && apt-get install -y postgresql-client
    - until pg_isready -h postgres -p 5432 -U myuser; do echo "Waiting for Postgres..."; sleep 2; done
    - git clone https://JSFlobert:glpat-hQtGYoDCnKN97RZkMCUo@gitlab.com/JSFlobert/sparkfit_prisma-schema.git
    - mkdir -p prisma
    - cp sparkfit_prisma-schema/schema.prisma prisma/
    - cp -r sparkfit_prisma-schema/migrations prisma/
    - rm -rf sparkfit_prisma-schema
    - npx prisma generate --schema=prisma/schema.prisma
    - until pg_isready -h postgres -p 5432 -U myuser; do echo "Waiting for Postgres..."; sleep 2; done


test:
  stage: test
  needs: [generate]
  variables:
    DATABASE_URL: $DATABASE_URL
  script:
    - echo DATABASE_URL
    - ls -la node_modules/.prisma/client
    - npm test

migrate:
  stage: migrate
  needs: [generate]
  script:
    - apt-get update && apt-get install -y postgresql-client
    - until pg_isready -h postgres -p 5432 -U myuser; do echo "Waiting for Postgres..."; sleep 2; done
    - npx prisma migrate deploy --schema=prisma/schema.prisma

build:
  stage: build
  needs: [generate]
  script:
    - npx prisma generate --schema=prisma/schema.prisma
    - npm run build

deploy:
  stage: deploy
  when: manual
  script:
    - echo "Déploiement manuel à adapter"
