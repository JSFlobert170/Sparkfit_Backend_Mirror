# ========================================
# GITLAB CI/CD - SPARKFIT BACKEND
# ========================================
# Ce fichier dit Ã  GitLab quoi faire quand vous poussez du code
# C'est comme une recette de cuisine automatisÃ©e !

# ========================================
# Ã‰TAPES DE LA PIPELINE
# ========================================
# Les Ã©tapes s'exÃ©cutent dans cet ordre :
# 1. test â†’ 2. build â†’ 3. deploy
stages:
  - test      # VÃ©rifier que le code fonctionne
  - build     # CrÃ©er l'image Docker
  - deploy    # Mettre en ligne (optionnel)

# ========================================
# VARIABLES GLOBALES
# ========================================
# Ces variables sont utilisÃ©es partout dans la pipeline
variables:
  # Image Docker de base (Node.js 18)
  NODE_IMAGE: "node:18-alpine"
  # Nom de notre application
  APP_NAME: "sparkfit-backend"
  # Port de l'application
  PORT: "3000"

# ========================================
# Ã‰TAPE 1: TESTS
# ========================================
# Cette Ã©tape vÃ©rifie que votre code fonctionne
test:
  # Seulement sur les branches develop et main
  only:
    - develop
    - main
  
  # Nom de l'Ã©tape
  stage: test
  
  # Image Docker Ã  utiliser
  image: $NODE_IMAGE
  
  # Services nÃ©cessaires (base de donnÃ©es pour les tests)
  services:
    - postgres:13-alpine
  
  # Variables d'environnement pour les tests
  variables:
    # Configuration de la base de donnÃ©es de test
    POSTGRES_DB: "test_db"
    POSTGRES_USER: "test_user"
    POSTGRES_PASSWORD: "test_password"
    DATABASE_URL: "postgresql://test_user:test_password@postgres:5432/test_db"
    NODE_ENV: "test"
    JWT_SECRET: "test-secret-key"
  
  # Scripts Ã  exÃ©cuter (comme des commandes dans le terminal)
  script:
    - echo "ğŸš€ DÃ©but des tests"
    - echo "ğŸ“ RÃ©pertoire: $CI_PROJECT_DIR"
    - echo "ğŸ”§ Branche: $CI_COMMIT_REF_SLUG"
    - echo "ğŸ“¦ Installation des dÃ©pendances backend..."
    - npm ci
    - echo "ğŸ—„ï¸ Installation des dÃ©pendances Prisma..."
    - cd ../sparkfit_prisma-schema
    - npm ci
    - cd ../sparkfit_backend
    - echo "â³ Attente de la base de donnÃ©es..."
    - sleep 10
    - echo "ğŸ”§ GÃ©nÃ©ration du client Prisma..."
    - npx prisma generate --schema=../sparkfit_prisma-schema/schema.prisma
    - echo "ğŸ—„ï¸ Application des migrations..."
    - npx prisma migrate deploy --schema=../sparkfit_prisma-schema/schema.prisma
    - echo "ğŸ§ª ExÃ©cution des tests..."
    - npm test
    - echo "âœ… Tests terminÃ©s avec succÃ¨s!"
  
  # Fichiers Ã  conserver aprÃ¨s les tests
  artifacts:
    # Conserver les rapports de couverture
    paths:
      - coverage/
    # Conserver pendant 1 semaine
    expire_in: 1 week

# ========================================
# Ã‰TAPE 2: CONSTRUCTION DOCKER
# ========================================
# Cette Ã©tape crÃ©e une image Docker de votre application
build:
  # Seulement si les tests passent et sur develop/main
  only:
    - develop
    - main
  
  # Nom de l'Ã©tape
  stage: build
  
  # Utiliser Docker pour construire Docker
  image: docker:20.10.16
  
  # Service Docker nÃ©cessaire
  services:
    - docker:20.10.16-dind
  
  # Variables pour Docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$CI_PROJECT_DIR/certs/client"
  
  # Scripts Ã  exÃ©cuter
  script:
    - echo "ğŸ”¨ DÃ©but de la construction Docker"
    - echo "ğŸ“¦ Application: $APP_NAME"
    - echo "ğŸ—ï¸ Construction de l'image..."
    - docker build -t $APP_NAME:$CI_COMMIT_SHORT_SHA .
    - docker build -t $APP_NAME:latest .
    - echo "ğŸ“‹ Images construites:"
    - docker images | grep $APP_NAME
    - echo "ğŸ§ª Test rapide de l'image..."
    - docker run --rm $APP_NAME:$CI_COMMIT_SHORT_SHA node --version
    - echo "âœ… Construction terminÃ©e!"
  
  # Fichiers Ã  conserver
  artifacts:
    paths:
      - docker-images/
    expire_in: 1 month

# ========================================
# Ã‰TAPE 3: DÃ‰PLOIEMENT STAGING
# ========================================
# Cette Ã©tape met l'application en ligne pour les tests
deploy_staging:
  # Seulement sur develop
  only:
    - develop
  
  # Nom de l'Ã©tape
  stage: deploy
  
  # Image simple
  image: alpine:latest
  
  # Scripts Ã  exÃ©cuter
  script:
    - echo "ğŸš€ DÃ©ploiement en staging..."
    - echo "ğŸ“¦ Application: $APP_NAME"
    - echo "ğŸ”§ Version: $CI_COMMIT_SHORT_SHA"
    - echo "âœ… DÃ©ploiement staging terminÃ©!"
  
  # Environnement de dÃ©ploiement
  environment:
    name: staging
    url: https://staging.sparkfit.com

# ========================================
# Ã‰TAPE 4: DÃ‰PLOIEMENT PRODUCTION
# ========================================
# Cette Ã©tape met l'application en production
deploy_production:
  # Seulement sur main
  only:
    - main
  
  # Nom de l'Ã©tape
  stage: deploy
  
  # Image simple
  image: alpine:latest
  
  # Scripts Ã  exÃ©cuter
  script:
    - echo "ğŸš€ DÃ©ploiement en production..."
    - echo "ğŸ“¦ Application: $APP_NAME"
    - echo "ğŸ”§ Version: $CI_COMMIT_SHORT_SHA"
    - echo "âœ… DÃ©ploiement production terminÃ©!"
  
  # Environnement de dÃ©ploiement
  environment:
    name: production
    url: https://sparkfit.com
  
  # DÃ©ploiement manuel (nÃ©cessite une validation humaine)
  when: manual

# ========================================
# CONFIGURATIONS OPTIONNELLES
# ========================================

# Cache pour accÃ©lÃ©rer les builds
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/
    - ../sparkfit_prisma-schema/node_modules/

# ========================================
# COMMENT UTILISER CETTE PIPELINE
# ========================================
# 
# 1. Poussez du code sur 'develop' :
#    git push origin develop
#    â†’ Lance automatiquement : test â†’ build â†’ staging
#
# 2. Mettez en production (sur 'main') :
#    git checkout main
#    git merge develop
#    git push origin main
#    â†’ Lance automatiquement : test â†’ build â†’ production (manuel)
#
# 3. Surveillez sur GitLab :
#    - Allez dans votre projet
#    - Cliquez sur "CI/CD" â†’ "Pipelines"
#    - Cliquez sur un pipeline pour voir les dÃ©tails
#
# ========================================
